name: Bot > Release Please

run-name: >-
  ${{ github.workflow }} > ${{ inputs.owner }}/${{ inputs.repo }}@${{ inputs.ref }}

on:
  workflow_dispatch:
    inputs:
      check_run_id:
        description: check_run_id
        required: true
        type: number
      owner:
        description: owner
        required: true
        type: string
      repo:
        description: repo
        required: true
        type: string
      ref:
        description: ref
        required: true
        type: string

concurrency:
  group: >-
    ${{ github.workflow }} > ${{ inputs.owner }}/${{ inputs.repo }}@${{ inputs.ref }}
  cancel-in-progress: false

jobs:
  start:
    name: Start
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@dist
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ inputs.owner }}
          repositories: ${{ inputs.repo }}
      - name: Update Check Run
        # ref: <https://docs.github.com/en/rest/checks/runs?apiVersion=2022-11-28#update-a-check-run>
        run: >-
          gh api '/repos/${{ inputs.owner }}/${{ inputs.repo }}/check-runs/${{ inputs.check_run_id }}'
          --field details_url='${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}'
          --field started_at="$(date --iso-8601='seconds')"
          --field status='in_progress'
          --method PATCH
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}

  config:
    name: Config
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    outputs:
      config-file: ${{ steps.config.outputs.config-file }}
      manifest-file: ${{ steps.config.outputs.manifest-file }}
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@dist
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ inputs.owner }}
          repositories: ${{ inputs.repo }}
      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          ref: ${{ inputs.ref }}
          token: ${{ steps.auth.outputs.token }}
      - id: config
        name: Find Config Files
        run: |-
          config='.config/release-please/config.json'
          manifest='.config/release-please/.manifest.json'
          if [[ -f $config ]]; then
            printf 'config-file=%s\n' "$config" >> "$GITHUB_OUTPUT"
          fi
          if [[ -f $manifest ]]; then
            printf 'manifest-file=%s\n' "$manifest" >> "$GITHUB_OUTPUT"
          fi

  release-please:
    name: Release Please
    needs:
      - config
    if: ${{ needs.config.outputs.config-file && needs.config.outputs.manifest-file }}
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    outputs:
      pr: ${{ steps.release-please.outputs.pr }}
      prs_created: ${{ steps.release-please.outputs.prs_created }}
      release_created: ${{ steps.release-please.outputs.release_created }}
      tag: ${{ steps.release-please.outputs.tag_name }}
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@dist
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ inputs.owner }}
          repositories: ${{ inputs.repo }}
      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          ref: ${{ inputs.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
      - id: release-please
        name: Release Please
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ steps.auth.outputs.token }}
          config-file: ${{ needs.config.outputs.config-file }}
          manifest-file: ${{ needs.config.outputs.manifest-file }}
          repo-url: ${{ inputs.owner }}/${{ inputs.repo }}

  changelog-pr:
    name: Changelog (PR)
    needs:
      - release-please
    if: ${{ needs.release-please.outputs.pr }}
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    steps:
      - id: auth
        name: Authenticate
        uses: liblaf/actions/auth@dist
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ inputs.owner }}
          repositories: ${{ inputs.repo }}
      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
      - id: tag
        name: Get Tag
        run: |-
          title='${{ fromJson(needs.release-please.outputs.pr).title }}'
          version="$(awk '{ print $NF }' <<< "$title")"
          printf 'tag=%s\n' "v$version" >> "$GITHUB_OUTPUT"
      - name: Changelog
        uses: liblaf/actions/changelog@dist
        with:
          output: CHANGELOG.md
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          args: --tag '${{ steps.tag.outputs.tag }}'
      - name: Commit
        uses: liblaf/actions/commit@dist
        with:
          add-options: --verbose 'CHANGELOG.md'
          message: "chore(docs): update CHANGELOG.md"
          owner: ${{ inputs.owner }}
          ref: ${{ fromJson(needs.release-please.outputs.pr).headBranchName }}
          repository: ${{ inputs.repo }}
          token: ${{ steps.auth.outputs.token }}

  changelog-release:
    name: Changelog (Release)
    needs:
      - release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    steps:
      - id: auth
        name: Authenticate
        uses: liblaf/actions/auth@dist
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ inputs.owner }}
          repositories: ${{ inputs.repo }}
      - name: Checkout
        uses: actions/checkout@v5
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          ref: ${{ needs.release-please.outputs.tag }}
          token: ${{ steps.auth.outputs.token }}
          fetch-depth: 0
      - id: changelog
        name: Changelog
        uses: liblaf/actions/changelog@dist
        with:
          repository: ${{ inputs.owner }}/${{ inputs.repo }}
          args: --current --strip all
      - name: Update Release
        run: >-
          gh release --repo '${{ inputs.owner }}/${{ inputs.repo }}'
          edit '${{ needs.release-please.outputs.tag }}'
          --notes-file '${{ steps.changelog.outputs.changelog }}'
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}

  complete:
    name: Complete
    needs:
      - start
      - release-please
      - changelog-pr
      - changelog-release
    if: always()
    runs-on: ubuntu-latest
    environment:
      name: Release Please
    steps:
      - id: auth
        name: Auth
        uses: liblaf/actions/auth@dist
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}
          owner: ${{ inputs.owner }}
          repositories: ${{ inputs.repo }}
      - name: Update Check Run
        # ref: <https://docs.github.com/en/rest/checks/runs?apiVersion=2022-11-28#update-a-check-run>
        run: >-
          gh api '/repos/${{ inputs.owner }}/${{ inputs.repo }}/check-runs/${{ inputs.check_run_id }}'
          --field conclusion='${{ needs.release-please.result }}'
          --field completed_at="$(date --iso-8601='seconds')"
          --method PATCH
        env:
          GH_TOKEN: ${{ steps.auth.outputs.token }}
